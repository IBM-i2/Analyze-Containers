# i2 Analyze Tool

An i2 Analyze Tool container is an ephemeral container that is used to run the i2 Analyze tools. For more information about the tools, see [i2 Analyze tools](../tools%20and%20functions/i2analyze_tools.md).

## Building the i2 Analyze Tool image

The i2 Analyze Tool image is built from the Dockerfile in `images/i2a_tools`.

The image contains the `i2-tools` & `scripts` folder from the toolkit.

### Docker build command

The following `docker build` command builds the i2 Analyze Tool image:

```bash
docker image build -t i2a_tools_redhat images/i2a_tools \
  --build-arg USER_UID="$(id -u "${USER}")"
```

The `--build-arg` flag is used to provide your local user ID to the Docker image when it is built. The value of `$USER` comes from your shell.

The local user ID is required so that a user is created in the Docker container with the same user ID as the local user. The user is required to ensure that the local user can access any files that are generated on the container and mounted to the host via a bind mount.

For examples of the build commands, see `buildImages.sh` script.

## Running an i2 Analyze Tool container

An i2 Analyze Tool container uses the i2 Analyze Tool image. In the `docker run` command, you can use `-e` to pass environment variables to the container. The environment variables are described in [environment variables](#environment-variables)

For more information about the command, see [docker run reference](https://docs.docker.com/engine/reference/run/).

### Docker run command

The following `docker run` command runs an i2 Analyze Tool container:

```bash
  docker run \
    --rm \
    --name "i2atool" \
    --network "eia" \
    --user "$(id -u "${USER}"):$(id -u "${USER}")" \
    -v "/environments/pre-prod/configuration:/opt/configuration" \
    -v "/environments/pre-prod/database-scripts/generated:/opt/databaseScripts/generated" \
    -e LIC_AGREEMENT="ACCEPT" \
    -e ZK_HOST="zk1.eia:2281,zk2.eia:2281,zk3.eia:2281" \
    -e DB_DIALECT="sqlserver" \
    -e DB_SERVER="sqlserver.eia" \
    -e DB_PORT=1433 \
    -e DB_NAME="ISTORE" \
    -e CONFIG_DIR="/opt/configuration" \
    -e GENERATED_DIR="/opt/databaseScripts/generated" \
    -e DB_USERNAME="dba" \
    -e DB_PASSWORD="DBA_PASSWORD" \
    -e DB_OS_TYPE="UNIX" \
    -e DB_INSTALL_DIR="/opt/mssql-tools" \
    -e DB_LOCATION_DIR="/var/opt/mssql/data" \
    -e SOLR_ADMIN_DIGEST_USERNAME="solr" \
    -e SOLR_ADMIN_DIGEST_PASSWORD="SOLR_ADMIN_DIGEST_PASSWORD" \
    -e ZOO_DIGEST_USERNAME="sol$" \
    -e ZOO_DIGEST_PASSWORD="ZOO_DIGEST_PASSWORD" \
    -e ZOO_DIGEST_READONLY_USERNAME="readonly-user" \
    -e ZOO_DIGEST_READONLY_PASSWORD="ZOO_DIGEST_READONLY_PASSWORD" \
    -e DB_SSL_CONNECTION=true \
    -e SOLR_ZOO_SSL_CONNECTION=true \
    -e SSL_PRIVATE_KEY="SSL_PRIVATE_KEY" \
    -e SSL_CERTIFICATE="SSL_CERTIFICATE" \
    -e SSL_CA_CERTIFICATE="SSL_CA_CERTIFICATE" \
    "i2a_tools_redhat" "$@"
```

### Bind mounts

- **Secrets**:  
A directory that contains all of the secrets that this tool requires. Specifically this includes credentials to access the database and a certificate used in SSL.  
The directory is mounted to a location in the container defined by the `CONTAINER_SECRETS_DIR` environment variable. This can then be used by other environment variables such as `DB_PASSWORD_FILE` to locate the secrets.  
In a production environment, the orchestration environment can provide the secrets to the file system or the secrets can be passed in via environment variables. The mechanism that is used here simulates the orchestration system providing the secrets as files. This is achieved by using a bind mount. In production this would not be required.

- **Configuration**:  
The i2 Analyze Tool container requires the i2 Analyze configuration. To access the configuration, the `configuration` directory must be mounted into the container. The `CONFIG_DIR` environment variable must specify the location where the configuration is mounted.

- **Generated scripts directory**:  
Some of the i2 Analyze tools generate scripts to be run against the Information Store database, or run scripts that were generated by other i2 Analyze tools. For the i2 Analyze Tool container to interact with these scripts, the directory where they are generated must be mounted into the container.  
In the example scripts, this is defaulted to `/database-scripts/generated`. The `GENERATED_DIR` environment variable must specify the location where the generated scripts are mounted.  

This directory must be created with your local user before mounting it to the container, otherwise docker will create this directory as a root.

### Environment variables

To configure the i2 Analyze Tool container, you provide environment variables to the Docker container in the `docker run` command.

The following table describes the supported environment variables that you can use:

| Environment variable              | Description |
| --------------------------------- | ----------- |
| `LIC_AGREEMENT`                   | The license agreement for use the i2Analyze tools.|
| `ZK_HOST`                         | The connection string the ZooKeeper client to connect to. |
| `DB_DIALECT`                      | See [i2a Tools Environment Variables](../tools%20and%20functions/i2analyze_tools.md#connection-properties).|
| `DB_SERVER`                       | See [i2a Tools Environment Variables](../tools%20and%20functions/i2analyze_tools.md#connection-properties).|
| `DB_PORT`                         | See [i2a Tools Environment Variables](../tools%20and%20functions/i2analyze_tools.md#connection-properties). |
| `DB_NAME`                         | See [i2a Tools Environment Variables](../tools%20and%20functions/i2analyze_tools.md#connection-properties). |
| `CONFIG_DIR`                      | The root location of the configuration directory. |
| `GENERATED_DIR`                   | The root location where any generated scripts are created. |
| `CLASSES_PATH`                    | The location to the files required by the i2 Analyze tools. The files are built into the image. |
| `DB_USERNAME`                     | See [i2a Tools Environment Variables](../tools%20and%20functions/i2analyze_tools.md#connection-properties). |
| `DB_PASSWORD`                     | See [i2a Tools Environment Variables](../tools%20and%20functions/i2analyze_tools.md#connection-properties). |
| `SOLR_ADMIN_DIGEST_USERNAME`      | The name of the administrator user for performing administration tasks. |
| `SOLR_ADMIN_DIGEST_PASSWORD`      | The password for the administrator user. |
| `ZOO_DIGEST_USERNAME`             | The ZooKeeper administrator user name. This environment variable maps to the `zkDigestUsername` system property. |
| `ZOO_DIGEST_PASSWORD`             | The ZooKeeper administrator password. This environment variable maps to the `zkDigestPassword` system property. |
| `ZOO_DIGEST_READONLY_USERNAME`    | The ZooKeeper read-only user name. This environment variable maps to the `zkDigestReadonlyUsername` system property. |
| `ZOO_DIGEST_READONLY_PASSWORD`    | The ZooKeeper read-only password. This environment variable maps to the `zkDigestReadonlyPassword` system property. |


The following environment variables enable you to use SSL:

| Environment variable      | Description |
| ------------------------- | ----------- |
| `DB_SSL_CONNECTION`       | See [Secure Environment variables](../security%20and%20users/security.md#secure-environment-variables). |
| `SOLR_ZOO_SSL_CONNECTION` | See [Secure Environment variables](../security%20and%20users/security.md#secure-environment-variables). |
| `SSL_PRIVATE_KEY_FILE`    | See [Secure Environment variables](../security%20and%20users/security.md#secure-environment-variables). | 
| `SSL_CERTIFICATE_FILE`    | See [Secure Environment variables](../security%20and%20users/security.md#secure-environment-variables). |
| `SSL_CA_CERTIFICATE_FILE` | See [Secure Environment variables](../security%20and%20users/security.md#secure-environment-variables). | 
